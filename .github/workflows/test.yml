name: Test scancompare on Release Branches

on:
  push:
    branches:
      - 'release-*'  # This triggers the workflow only on release branches (e.g., release-1.1.0)
  pull_request:
    branches:
      - 'release-*'  # This triggers the workflow on pull requests to release branches

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      docker:
        image: docker:19.03.12
        options: --privileged # Ensure Docker can run in the GitHub Actions runner

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Python environment
      - name: Set up Python 3.8
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      # Install dependencies using install.sh
      - name: Run install.sh to set up the environment
        run: |
          bash <(curl -fsSL https://raw.githubusercontent.com/drewtwitchell/scancompare/main/install.sh)

      # Set up Docker (this is required to run docker commands)
      - name: Set up Docker
        run: |
          sudo apt-get update
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo systemctl start docker
          sudo systemctl enable docker

      # Test scanning a GitHub repository with Dockerfile (auto-answer prompts using --auto)
      - name: Test scancompare with GitHub repo URL and Docker build (Mock Yes)
        run: |
          echo "Testing scancompare with GitHub repo URL and Docker build (Mock Yes)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --auto --mock-yes

      - name: Test scancompare with GitHub repo URL and Docker build (Mock No)
        run: |
          echo "Testing scancompare with GitHub repo URL and Docker build (Mock No)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --auto --mock-no

      - name: Test scancompare with GitHub repo URL and Docker build (Auto)
        run: |
          echo "Testing scancompare with GitHub repo URL and Docker build (Auto)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --auto

      - name: Test scancompare with GitHub repo URL and Docker build (Interactive Yes)
        run: |
          echo "Testing scancompare with GitHub repo URL and Docker build (Interactive Yes)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --auto --mock-yes

      - name: Test scancompare with GitHub repo URL and Docker build (Interactive No)
        run: |
          echo "Testing scancompare with GitHub repo URL and Docker build (Interactive No)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --auto --mock-no

      # Test upload to GitHub Advanced Security (GHAS) with --auto flag
      - name: Test upload to GHAS (Mock Yes)
        run: |
          echo "Testing scancompare with GHAS upload (Mock Yes)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --ghas --auto --mock-yes

      - name: Test upload to GHAS (Mock No)
        run: |
          echo "Testing scancompare with GHAS upload (Mock No)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --ghas --auto --mock-no

      - name: Test upload to GHAS (Auto)
        run: |
          echo "Testing scancompare with GHAS upload (Auto)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --ghas --auto

      - name: Test upload to GHAS (Interactive Yes)
        run: |
          echo "Testing scancompare with GHAS upload (Interactive Yes)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --ghas --auto --mock-yes

      - name: Test upload to GHAS (Interactive No)
        run: |
          echo "Testing scancompare with GHAS upload (Interactive No)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --ghas --auto --mock-no

      # Test publishing report to GitHub Pages with --auto flag
      - name: Test publish to GitHub Pages (Mock Yes)
        run: |
          echo "Testing scancompare with GitHub Pages upload (Mock Yes)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --gh-pages --auto --mock-yes

      - name: Test publish to GitHub Pages (Mock No)
        run: |
          echo "Testing scancompare with GitHub Pages upload (Mock No)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --gh-pages --auto --mock-no

      - name: Test publish to GitHub Pages (Auto)
        run: |
          echo "Testing scancompare with GitHub Pages upload (Auto)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --gh-pages --auto

      - name: Test publish to GitHub Pages (Interactive Yes)
        run: |
          echo "Testing scancompare with GitHub Pages upload (Interactive Yes)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --gh-pages --auto --mock-yes

      - name: Test publish to GitHub Pages (Interactive No)
        run: |
          echo "Testing scancompare with GitHub Pages upload (Interactive No)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --gh-pages --auto --mock-no

      # Test verbose mode with --auto flag
      - name: Test scancompare in verbose mode (Auto)
        run: |
          echo "Testing scancompare in verbose mode (Auto)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --verbose --auto

      - name: Test scancompare in verbose mode (Interactive Yes)
        run: |
          echo "Testing scancompare in verbose mode (Interactive Yes)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --verbose --auto --mock-yes

      - name: Test scancompare in verbose mode (Interactive No)
        run: |
          echo "Testing scancompare in verbose mode (Interactive No)..."
          python scancompare --repo-url https://github.com/docker-library/hello-world --verbose --auto --mock-no

      # Test version check with --auto flag
      - name: Test scancompare version (Auto)
        run: |
          echo "Testing scancompare version (Auto)..."
          python scancompare --version --auto

      - name: Test scancompare version (Interactive Yes)
        run: |
          echo "Testing scancompare version (Interactive Yes)..."
          python scancompare --version --auto --mock-yes

      - name: Test scancompare version (Interactive No)
        run: |
          echo "Testing scancompare version (Interactive No)..."
          python scancompare --version --auto --mock-no

      # Test update functionality with --auto flag
      - name: Test scancompare update (Auto)
        run: |
          echo "Testing scancompare update (Auto)..."
          python scancompare --update --auto

      - name: Test scancompare update (Interactive Yes)
        run: |
          echo "Testing scancompare update (Interactive Yes)..."
          python scancompare --update --auto --mock-yes

      - name: Test scancompare update (Interactive No)
        run: |
          echo "Testing scancompare update (Interactive No)..."
          python scancompare --update --auto --mock-no

      # Test uninstall functionality with --auto flag
      - name: Test scancompare uninstall (Auto)
        run: |
          echo "Testing scancompare uninstall (Auto)..."
          python scancompare --uninstall --auto

      - name: Test scancompare uninstall (Interactive Yes)
        run: |
          echo "Testing scancompare uninstall (Interactive Yes)..."
          python scancompare --uninstall --auto --mock-yes

      - name: Test scancompare uninstall (Interactive No)
        run: |
          echo "Testing scancompare uninstall (Interactive No)..."
          python scancompare --uninstall --auto --mock-no

      # Check for failed tests and stop the build if any test fails
      - name: Check for failed tests
        run: |
          if [[ $? -ne 0 ]]; then
            echo "Some tests failed! Exiting the build."
            exit 1
          fi