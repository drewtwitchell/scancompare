#!/usr/bin/env python3
# scancompare version 1.7.1

import os
import sys
import json
import subprocess
import platform
from datetime import datetime
from urllib.request import urlopen
from pathlib import Path
import webbrowser

SCRIPT_NAME = "scancompare"
SCRIPT_URL = "https://raw.githubusercontent.com/drewtwitchell/scancompare/main/scancompare"
VERSION = "1.7.1"

def check_latest_version(only_check=False):
    try:
        latest = urlopen(SCRIPT_URL).read().decode("utf-8").split("VERSION = ")[1].split("\n")[0].strip('"')
        if latest != VERSION:
            print(f"üîÑ New version available: {VERSION} ‚Üí {latest}")
            update_script()
            print("‚úÖ scancompare updated to latest version")
            if only_check:
                sys.exit(0)
            os.execv(sys.executable, [sys.executable] + sys.argv)
        elif only_check:
            print(f"üì¶ scancompare version {VERSION}")
            sys.exit(0)
    except Exception:
        print("‚ö†Ô∏è Could not determine remote version.")
        if only_check:
            print(f"üì¶ scancompare version {VERSION}")
            sys.exit(0)

def update_script():
    try:
        new_code = urlopen(SCRIPT_URL).read().decode("utf-8")
        script_path = Path(__file__)
        script_path.write_text(new_code)
    except Exception as e:
        print("‚ùå Failed to update script:", e)

def get_version(tool):
    try:
        result = subprocess.run([tool, "--version"], capture_output=True, text=True)
        return result.stdout.strip().split("\n")[0]
    except Exception:
        return "unknown"

def run_scan(tool, image, output_path):
    try:
        if tool == "trivy":
            cmd = [tool, "image", "-f", "json", "-o", str(output_path), image]
            subprocess.run(cmd, check=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        elif tool == "grype":
            with open(output_path, "w") as f:
                subprocess.run([tool, image, "-o", "json"], check=True, stdout=f, stderr=subprocess.DEVNULL)
        return True
    except subprocess.CalledProcessError:
        return False

def extract_cves(file_path):
    try:
        with open(file_path) as f:
            data = json.load(f)
        vulns = set()
        if "matches" in data:  # Grype
            for match in data["matches"]:
                vuln = match.get("vulnerability", {})
                if "id" in vuln:
                    vulns.add(vuln["id"])
        elif "Results" in data:  # Trivy
            for result in data["Results"]:
                for vuln in result.get("Vulnerabilities", []):
                    vulns.add(vuln["VulnerabilityID"])
        return vulns
    except Exception:
        return set()

def display_summary(trivy_cves, grype_cves):
    shared = trivy_cves & grype_cves
    only_trivy = trivy_cves - grype_cves
    only_grype = grype_cves - trivy_cves

    print("\nüìä CLI Summary Report\n")
    print("Tool       | Total | Only in Tool | Shared")
    print("-----------|-------|---------------|--------")
    print(f"Grype      | {len(grype_cves)}   | {len(only_grype)}             | {len(shared)}")
    print(f"Trivy      | {len(trivy_cves)}   | {len(only_trivy)}            | {len(shared)}")
    return shared, only_trivy, only_grype

def explain_exit(msg):
    print(f"‚ö†Ô∏è {msg}")
    sys.exit(1)

def generate_html_report(image, trivy_json, grype_json, shared, only_trivy, only_grype):
    timestamp = datetime.now().strftime("%Y-%m-%d")
    report_name = f"scan_report_{image.replace(':', '_')}_{timestamp}.html"
    report_path = Path("scan_reports") / report_name

    def make_html_block(title, items):
        if not items:
            return f"<h3>{title}</h3><p>No CVEs found.</p>"
        grouped = {"Critical": [], "High": [], "Medium": [], "Low": [], "Unknown": []}
        for cve in sorted(items):
            sev = "Unknown"
            if "CRIT" in cve.upper():
                sev = "Critical"
            elif "HIGH" in cve.upper():
                sev = "High"
            elif "MED" in cve.upper():
                sev = "Medium"
            elif "LOW" in cve.upper():
                sev = "Low"
            grouped[sev].append(cve)
        block = f"<h3 id='{title.lower().replace(' ', '_')}'>{title}</h3>"
        for sev in ["Critical", "High", "Medium", "Low", "Unknown"]:
            if grouped[sev]:
                block += f"<details><summary>{sev} ({len(grouped[sev])})</summary><ul>"
                for cve in grouped[sev]:
                    block += f"<li>{cve}</li>"
                block += "</ul></details>"
        return block

    html = f"""<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ScanCompare Report for {image}</title>
    <style>
        body {{ font-family: Arial, sans-serif; padding: 20px; }}
        h1, h2 {{ color: #333; }}
        .toc a {{ display: block; margin-bottom: 4px; }}
        pre {{ background: #f4f4f4; padding: 10px; }}
    </style>
</head>
<body>
    <h1>Scan Report for {image}</h1>
    <button onclick="window.print()">üñ®Ô∏è Export as PDF</button>
    <h2>Table of Contents</h2>
    <div class="toc">
        <a href="#summary">Summary</a>
        <a href="#shared_cves">Shared CVEs</a>
        <a href="#trivy_unique">Unique to Trivy</a>
        <a href="#grype_unique">Unique to Grype</a>
    </div>
    <hr>
    <h2 id="summary">Summary</h2>
    <pre>
Tool       | Total | Only in Tool | Shared
-----------|-------|---------------|--------
Grype      | {len(only_grype) + len(shared)}   | {len(only_grype)}             | {len(shared)}
Trivy      | {len(only_trivy) + len(shared)}   | {len(only_trivy)}            | {len(shared)}
    </pre>
    {make_html_block("Shared CVEs", shared)}
    {make_html_block("Unique to Trivy", only_trivy)}
    {make_html_block("Unique to Grype", only_grype)}
</body>
</html>
"""
    report_path.write_text(html)
    print(f"‚úÖ HTML report saved: {report_path}")
    open_html = input("üìÅ Open report in browser? (y/n): ").strip().lower()
    if open_html == "y":
        webbrowser.open(f"file://{report_path.absolute()}")

def main():
    if len(sys.argv) == 2 and sys.argv[1] in ("--version", "version"):
        print(f"üì¶ scancompare version {VERSION}")
        sys.exit(0)
    if len(sys.argv) == 2 and sys.argv[1] == "update":
        check_latest_version(only_check=True)

    if len(sys.argv) < 2:
        print("Usage: scancompare <image>")
        sys.exit(1)

    image = sys.argv[1]
    check_latest_version()

    scan_dir = Path("scan_reports")
    scan_dir.mkdir(exist_ok=True)
    trivy_path = scan_dir / "original_trivy.json"
    grype_path = scan_dir / "original_grype.json"

    print(f"\nüîπ Scanning with Trivy...")
    trivy_version = get_version("trivy")
    print(f"   üì¶ Trivy version: {trivy_version}")
    if not run_scan("trivy", image, trivy_path):
        explain_exit("Trivy scan failed or image not found.")
    print(f"    ‚úî Trivy scan saved to {trivy_path}")

    print(f"\nüîπ Scanning with Grype...")
    grype_version = get_version("grype")
    print(f"   üì¶ Grype version: {grype_version}")
    if not run_scan("grype", image, grype_path):
        explain_exit("Grype scan failed or image not found.")
    print(f"    ‚úî Grype scan saved to {grype_path}")

    trivy_cves = extract_cves(trivy_path)
    grype_cves = extract_cves(grype_path)
    shared, only_trivy, only_grype = display_summary(trivy_cves, grype_cves)

    print("\nüîç CVEs by Severity")
    print("\nüî∏ Unique to Grype")
    for cve in sorted(only_grype): print(f"  - {cve}")
    print("\nüî∏ Unique to Trivy")
    for cve in sorted(only_trivy): print(f"  - {cve}")
    print("\nüî∏ Shared CVEs")
    for cve in sorted(shared): print(f"  - {cve}")

    generate_html_report(image, trivy_path, grype_path, shared, only_trivy, only_grype)

if __name__ == "__main__":
    main()
