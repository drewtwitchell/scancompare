#!/usr/bin/env bash
VERSION="1.3.9"
SCRIPT_NAME="scancompare"
SCRIPT_PATH="$HOME/.local/bin/$SCRIPT_NAME"
REPO_USER="drewtwitchell"
REPO_NAME="scancompare"
REMOTE_URL="https://raw.githubusercontent.com/$REPO_USER/$REPO_NAME/main/$SCRIPT_NAME"

if [[ "$1" == "--no-update" ]]; then SKIP_UPDATE=true; shift; else SKIP_UPDATE=false; fi

TARGET="$1"
ORIGINAL_TARGET="$TARGET"
REPORT_DIR="scan_reports"
TIMESTAMP=$(date +"%Y-%m-%d")
HTML_REPORT="$REPORT_DIR/scan_report_${ORIGINAL_TARGET//[\/:]/_}_$TIMESTAMP.html"

ORIG_GRYPE="$REPORT_DIR/original_grype.json"
ORIG_TRIVY="$REPORT_DIR/original_trivy.json"
ORIG_DIFF="$REPORT_DIR/original_diff.json"

step() { echo -e "\nüîπ $1"; }
done_msg() { echo "    ‚úî $1"; }

get_remote_version() {
  curl -fsSL "$REMOTE_URL" | grep 'VERSION=' | cut -d'"' -f2
}

auto_update_check() {
  remote_ver=$(get_remote_version)
  if [[ "$VERSION" != "$remote_ver" ]]; then
    echo "üîÑ New version available: $remote_ver (current: $VERSION)"
    self_update "$@"
  fi
}

self_update() {
  local tmp_file
  tmp_file=$(mktemp)
  curl -fsSL "$REMOTE_URL" -o "$tmp_file" || { echo "‚ùå Failed to fetch update."; exit 1; }
  local remote_version
  remote_version=$(grep '^VERSION=' "$tmp_file" | cut -d'"' -f2)
  if [[ "$remote_version" == "$VERSION" ]]; then rm -f "$tmp_file"; return; fi
  chmod +x "$tmp_file"
  cp "$tmp_file" "$SCRIPT_PATH"
  rm -f "$tmp_file"
  echo "‚úÖ scancompare updated to version $remote_version"
  exec "$SCRIPT_PATH" --no-update "$@"
}

check_tools() {
  mkdir -p ~/.local/bin
  export PATH="$HOME/.local/bin:$PATH"
  for tool in grype trivy jq docker; do
    if ! command -v $tool &>/dev/null; then
      echo "üì¶ Installing $tool..."
      if command -v brew &>/dev/null; then
        brew install $tool
      else
        echo "‚ö†Ô∏è Please install '$tool' manually or via curl if brew is unavailable."
        exit 1
      fi
    fi
  done
}

clear_old_report() { rm -f "$HTML_REPORT"; }

run_scans() {
  mkdir -p "$REPORT_DIR"
  step "Scanning with Trivy..."
  trivy image --scanners vuln --format json --output "$ORIG_TRIVY" "$TARGET"
  done_msg "Trivy scan saved to $ORIG_TRIVY"
  step "Scanning with Grype..."
  grype "$TARGET" -o json > "$ORIG_GRYPE"
  done_msg "Grype scan saved to $ORIG_GRYPE"
}

compare_results() {
  step "Comparing scan results..."
  jq -r '[.Results[].Vulnerabilities[]? | {id: .VulnerabilityID, severity: .Severity}] | unique' "$ORIG_TRIVY" > "$REPORT_DIR/trivy.json"
  jq -r '[.matches[] | {id: .vulnerability.id, severity: .vulnerability.severity}] | unique' "$ORIG_GRYPE" > "$REPORT_DIR/grype.json"

  jq -n \
    --slurpfile trivy "$REPORT_DIR/trivy.json" \
    --slurpfile grype "$REPORT_DIR/grype.json" '
    def group_by_severity(cves):
      reduce cves[] as $v (
        {"Critical": [], "High": [], "Medium": [], "Low": [], "Unknown": []};
        .[$v.severity] += [$v.id]
      );

    def id_set(arr): arr | map(.id);

    def intersect(a; b): [a[] | select(b | index(.))];
    def diff(a; b): [a[] | select(b | index(.) | not)];

    {
      summary: {
        total_grype: ($grype[0] | length),
        total_trivy: ($trivy[0] | length),
        shared: (intersect(id_set($grype[0]); id_set($trivy[0])) | length),
        only_in_grype: (diff(id_set($grype[0]); id_set($trivy[0])) | length),
        only_in_trivy: (diff(id_set($trivy[0]); id_set($grype[0])) | length)
      },
      shared: group_by_severity([
        ($grype[0] + $trivy[0])[]
        | select((id_set($grype[0]) | index(.id)) and (id_set($trivy[0]) | index(.id)))
      ]),
      unique_grype: group_by_severity(diff($grype[0]; $trivy[0])),
      unique_trivy: group_by_severity(diff($trivy[0]; $grype[0])),
      actions: {
        suggestion: "Review shared CVEs and prioritize those with known fixes."
      }
    }
  ' > "$ORIG_DIFF"
  done_msg "Diff report saved to $ORIG_DIFF"

  echo -e "\nüìä CLI Summary Report"
  jq -r '
    "Tool       | Total | Only in Tool | Shared\n-----------|-------|--------------|--------" +
    "\nGrype      | \(.summary.total_grype)    | \(.summary.only_in_grype)           | \(.summary.shared)" +
    "\nTrivy      | \(.summary.total_trivy)    | \(.summary.only_in_trivy)           | \(.summary.shared)\n"
  ' "$ORIG_DIFF"

  jq -r '
    def print_group(title; data):
      if ([data[]] | flatten | length) > 0 then
        "\n" + title + ":\n" +
        (data | to_entries[] | select(.value | length > 0) | "\(.key): " + (.value | join(", ")))
      else ""
      end;
    print_group("üîê Shared CVEs by Severity"; .shared),
    print_group("üü¢ Unique to Trivy"; .unique_trivy),
    print_group("üîµ Unique to Grype"; .unique_grype),
    "\nSuggested Action: \(.actions.suggestion)"
  ' "$ORIG_DIFF"
}

generate_html_report() {
  {
    echo "<!DOCTYPE html><html><head><meta charset='UTF-8'><title>Scan Report</title>
    <style>body{font-family:sans-serif;padding:20px;max-width:900px;margin:auto} h1,h2,h3{color:#2c3e50} pre{background:#f4f4f4;padding:10px;border-radius:8px;overflow:auto;} button{margin:10px 0;padding:6px 10px;background:#2c3e50;color:#fff;border:none;border-radius:5px;cursor:pointer} table{border-collapse:collapse;width:100%;margin-top:1em} th,td{border:1px solid #ccc;padding:8px;text-align:left} ul{list-style-type:square;margin-left:20px}</style>
    <script>function toggle(id){var el=document.getElementById(id);el.style.display=(el.style.display==='none'||!el.style.display)?'block':'none'} function savePDF(){window.print();}</script></head><body>
    <h1>Scan Summary for <code>$ORIGINAL_TARGET</code></h1>
    <p><strong>Date:</strong> $TIMESTAMP</p>
    <button onclick='savePDF()'>üìÑ Download as PDF</button>"
    jq -r '
      "<table><tr><th>Tool</th><th>Total</th><th>Only in Tool</th><th>Shared</th></tr>" +
      "<tr><td>Grype</td><td>\(.summary.total_grype)</td><td>\(.summary.only_in_grype)</td><td>\(.summary.shared)</td></tr>" +
      "<tr><td>Trivy</td><td>\(.summary.total_trivy)</td><td>\(.summary.only_in_trivy)</td><td>\(.summary.shared)</td></tr></table>" +
      "<h3>Suggested Action</h3><p>\(.actions.suggestion)</p>"
    ' "$ORIG_DIFF"

    for section in shared unique_grype unique_trivy; do
      label=$(echo "$section" | sed 's/_/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')
      echo "<h3>$label CVEs</h3>"
      jq -r --arg sec "$section" '
        .[$sec] | to_entries[] | select(.value | length > 0) |
        "<h4>" + .key + "</h4><ul>" + (.value[] | "<li><a href=\"https://nvd.nist.gov/vuln/detail/\(.)\" target=\"_blank\">\(.)</a></li>") + "</ul>"
      ' "$ORIG_DIFF"
    done

    echo "<button onclick=\"toggle('raw_json')\">Toggle Raw JSON</button><pre id='raw_json' style='display:none;'>"
    jq . "$ORIG_DIFF"
    echo "</pre></body></html>"
  } > "$HTML_REPORT"
  echo "‚úÖ HTML report saved: $HTML_REPORT"
}

prompt_open_html() {
  echo -e "\nüìÅ Would you like to open the HTML report in your browser? (y/n)"
  read -r choice
  if [[ "$choice" == "y" ]]; then
    case "$OSTYPE" in
      darwin*) open "$HTML_REPORT" ;;
      linux*) xdg-open "$HTML_REPORT" ;;
      *) echo "View at: $HTML_REPORT" ;;
    esac
  else
    echo "üìé You can view it later at: $HTML_REPORT"
  fi
}

main() {
  [[ -z "$TARGET" ]] && echo "‚ùå Usage: scancompare <image>" && exit 1
  echo "üîç Starting vulnerability scan for image: $TARGET"
  check_tools
  clear_old_report
  run_scans
  compare_results
  generate_html_report
  prompt_open_html
}

[[ "$1" == "update" ]] && self_update "$@" && exit 0
$SKIP_UPDATE || auto_update_check "$@"

main "$@"
